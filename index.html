<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MML Converter for Lost Ark Drums</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .container { max-width: 600px; margin: auto; }
    textarea { width: 100%; box-sizing: border-box; }
    button { margin-top: 5px; padding: 8px 12px; margin-bottom: 15px;}
    
    .guide-text {
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LostSheet</h1>
    <h2>로스트아크 드럼을 위한 MML 변환기</h2>
    <div class="guide-text">
      <h2>사용 방법 안내</h2>
      <p>
        드럼 MML을 입력받아 <strong>로스트아크 드럼</strong>에 맞는 형태로 변환해주는 도구입니다.<br>
        1) 3MLE에 MIDI파일을 입력한다. <br>
        2) 클립보드로 MML을 출력한다.<br>
        3) 위 입력창에 MML을 입력한다.<br>
        4) Convert 버튼을 클릭한다.<br>
        5) 아래 출력창에 변환된 결과가 표시됩니다.<br>
      </p>
      <p>
        <a href="guide\guide.html" target="_blank">가이드 보기</a> <!-- 별도 페이지로 링크 -->
      </p>
    </div>
    
    <textarea id="inputMML" rows="8" placeholder="여기에 MML을 붙여 넣으세요"></textarea>
    <button id="convertButton">Convert</button>
    <textarea id="outputMML" rows="8" readonly placeholder="변환 결과가 여기에 표시됩니다"></textarea>
    <!-- 클립보드 복사 버튼 -->
    <button id="copyButton">Copy to Clipboard</button>
  </div>
  
  <script>
    document.getElementById("copyButton").addEventListener("click", function() {
      const outputText = document.getElementById("outputMML").value;
      navigator.clipboard.writeText(outputText)
        .then(() => {
          alert("클립보드에 복사되었습니다!");
        })
        .catch(err => {
          console.error("복사 실패: ", err);
        });
    });
    // NEW_DRUM_MAP: 절대음 → 로스트아크 드럼 노트 매핑
    const NEW_DRUM_MAP = {
      23: 53, 24: 53, 25: 60, 26: 57, 28: 57, 29: 55, 30: 69,
      31: 64, 32: 71, 33: 55, 34: 67, 35: 64, 36: 65, 37: 72,
      38: 65, 39: 76, 40: 72, 41: 77, 42: 74, 43: 72, 44: 60,
      45: 72, 47: 76
    };

    // 상대음 → 절대음 변환
    function relativeToAbsolute(octave, note) {
      let baseNote, accidental;
      if (note.endsWith('+')) {
        baseNote = note.slice(0, -1);
        accidental = 1;
      } else if (note.endsWith('-')) {
        baseNote = note.slice(0, -1);
        accidental = -1;
      } else {
        baseNote = note;
        accidental = 0;
      }
      const baseSemitones = { c: 0, d: 2, e: 4, f: 5, g: 7, a: 9, b: 11 };
      if (!(baseNote in baseSemitones)) return null;
      let semitone = baseSemitones[baseNote] + accidental;
      let absVal = octave * 12 + semitone;
      // o2 a 특수 보정
      if (octave === 2 && baseNote === 'a' && accidental === 0) {
        absVal += 2;
      }
      return absVal;
    }

    // 파싱 유틸
    function parseLengthMacro(token) {
      const m = token.match(/^l(\d+)(\.)?$/);
      if (m) {
        return { lengthVal: parseInt(m[1], 10), dotted: m[2] === '.' };
      }
      return null;
    }

    function parseNoteLength(token) {
      const m = token.match(/^([abcdefg][+\-]?)(\d+)?(\.?)$/);
      if (!m) return null;
      return {
        noteName: m[1],
        lengthVal: m[2] ? parseInt(m[2], 10) : null,
        dotted: m[3] === '.'
      };
    }

    function parseRestLength(token) {
      const m = token.match(/^r(\d*)(\.?)$/);
      if (!m) return null;
      return {
        lengthVal: m[1] ? parseInt(m[1], 10) : null,
        dotted: m[2] === '.'
      };
    }

    function parseAbsoluteLength(token) {
      const m = token.match(/^(n\d+)(\d+)?(\.?)$/);
      if (!m) return null;
      return {
        absNote: m[1],
        lengthVal: m[2] ? parseInt(m[2], 10) : null,
        dotted: m[3] === '.'
      };
    }

    // 메인 변환 함수
    function convertMmlForLostark(mml) {
      const tokenPattern = /(o\d+|[<>]|l\d+\.?|&|[abcdefg][+\-]?\d*\.?|r\d*\.?|n\d+\d*\.?|v\d+|t\d+|\d+\.?|\.)/g;
      const tokens = mml.match(tokenPattern) || [];
      let currentOctave = 4;
      let defaultLengthVal = 4;
      let defaultLengthDotted = false;
      const convertedTokens = [];

      tokens.forEach(token => {
        // 옥타브
        if (/^o\d+$/.test(token)) {
          currentOctave = parseInt(token.slice(1), 10);
          return;
        }
        if (token === '>') { currentOctave++; return; }
        if (token === '<') { currentOctave--; return; }

        // 길이 매크로
        const lengthMacro = parseLengthMacro(token);
        if (lengthMacro) {
          defaultLengthVal = lengthMacro.lengthVal;
          defaultLengthDotted = lengthMacro.dotted;
          convertedTokens.push(token);
          return;
        }

        // 붙임표
        if (token === '&') {
          convertedTokens.push(token);
          return;
        }

        // 쉼표
        const restInfo = parseRestLength(token);
        if (restInfo) {
          let lengthVal = restInfo.lengthVal;
          let dotted = restInfo.dotted;
          if (lengthVal === null) {
            lengthVal = defaultLengthVal;
            if (!dotted) dotted = defaultLengthDotted;
          }
          convertedTokens.push(`l${lengthVal}${dotted ? '.' : ''} r`);
          return;
        }

        // 절대음
        const absInfo = parseAbsoluteLength(token);
        if (absInfo) {
          let lengthVal = absInfo.lengthVal;
          let dotted = absInfo.dotted;
          if (lengthVal === null) {
            lengthVal = defaultLengthVal;
            if (!dotted) dotted = defaultLengthDotted;
          }
          convertedTokens.push(`l${lengthVal}${dotted ? '.' : ''} ${absInfo.absNote}`);
          return;
        }

        // 상대음
        const noteInfo = parseNoteLength(token);
        if (noteInfo) {
          const intermediate = relativeToAbsolute(currentOctave, noteInfo.noteName);
          let replacedStr;
          if (intermediate === null) {
            replacedStr = token;
          } else {
            const finalVal = NEW_DRUM_MAP[intermediate];
            if (finalVal === undefined) {
              replacedStr = token;
            } else {
              replacedStr = `n${finalVal}`;
            }
          }
          let lengthVal = noteInfo.lengthVal;
          let dotted = noteInfo.dotted;
          if (lengthVal === null) {
            lengthVal = defaultLengthVal;
            if (!dotted) dotted = defaultLengthDotted;
          }
          convertedTokens.push(`l${lengthVal}${dotted ? '.' : ''} ${replacedStr}`);
          return;
        }

        // 그 외
        convertedTokens.push(token);
      });

      // 붙임표 후처리
      for (let i = 0; i < convertedTokens.length; i++) {
        if (convertedTokens[i] === "&") {
          if (i + 1 < convertedTokens.length) {
            let tokenToReplace = convertedTokens[i + 1];
            tokenToReplace = tokenToReplace.replace(/^(l\d+(\.?)\s+)(n\d+)/, '$1r');
            convertedTokens[i + 1] = tokenToReplace;
          }
        }
      }
      
      let merged = convertedTokens.join(" ");
      merged = merged.replace(/(n\d+)\s+(?=n\d+)/g, '$1 ');
      return merged;
    }

    // 중복 l 매크로 제거
    function parseLMacro(token) {
      const re = /^l(\d+)(\.)?$/;
      const match = token.match(re);
      if (match) {
        return { lengthVal: parseInt(match[1], 10), dotted: match[2] === '.' };
      }
      return null;
    }

    function removeRedundantLMacros(mml) {
      const tokenPattern = /(l\d+\.?|[^\s]+)/g;
      const tokens = mml.match(tokenPattern) || [];
      let lastL = null;
      const resultTokens = [];
      
      tokens.forEach(token => {
        const lInfo = parseLMacro(token);
        if (lInfo) {
          if (lastL && lastL.lengthVal === lInfo.lengthVal && lastL.dotted === lInfo.dotted) {
            return; // 중복
          } else {
            lastL = lInfo;
            resultTokens.push(token);
          }
        } else {
          resultTokens.push(token);
        }
      });
      const merged = resultTokens.join(" ");
      return merged.replace(/\s+/g, "");
    }

    // 버튼 클릭 시 변환
    document.getElementById("convertButton").addEventListener("click", function() {
      const inputMML = document.getElementById("inputMML").value;
      const intermediate = convertMmlForLostark(inputMML);
      const finalResult = removeRedundantLMacros(intermediate);
      document.getElementById("outputMML").value = finalResult;
    });
  </script>
</body>
</html>
